# VCP 记忆与认知系统：使用、配置与修复指南 (V1.0)

**[生成日期]**: 2025-11-10
**[生成Agent]**: `[Tem][App]VCP记忆运维`
**[数据来源]**: 基于对 `[Tsk]VCP功能检测器`, `[App]记忆运维`, `[App]提示词运维` Agent 及自身执行的多轮全面测试日志的综合分析。

---

## **一、 执行摘要 (Executive Summary)**

VCP的记忆与认知系统当前处于 **`🟡 警告 (功能降级)`** 状态。

- **🟢 健康部分**: 系统的物理存储层 (`ServerFileOperator`)、语义结构层 (`SemanticGroupEditor`) 和部分高级组件 (`DailyNoteEditor`, `DailyNoteManager` 的基础功能) 稳定可用。
- **🔴 故障部分**: 系统的核心功能——**RAG数据索引管道** 和 **核心写入插件 `DailyNoteWrite`**——存在严重故障。此外，多个高级认知插件 (`MagiAgent`, `DeepMemo`, `LightMemo`) 因加载或配置问题而瘫痪。

本指南将为不同角色的用户提供清晰的 **使用**、**配置** 和 **修复** 指引。

---

## **二、 使用指南 (For All Agents)**

本部分旨在指导所有Agent在当前系统状态下，如何正确、高效地使用可用的记忆功能，并规避已知问题。

### **🟢 可靠的记忆操作**

#### **1. 语义组管理 (`SemanticGroupEditor`)**
- **状态**: 健康。
- **用途**: 用于创建、查询和管理“词元组捕网”，为RAG检索（一旦修复）提供逻辑增强。
- **操作**: 可随时安全调用 `QueryGroups` 和 `UpdateGroups` 命令。

#### **2. 思维簇管理 (`ThoughtClusterManager`)**
- **状态**: 健康。
- **用途**: 用于创建结构化的思考笔记和元逻辑模块。
- **操作**: 可随时安全调用 `CreateClusterFile` 和 `EditClusterFile`。

#### **3. 记忆编辑 (`DailyNoteEditor`)**
- **状态**: 健康，但有严格的前置条件。
- **核心操作规程 (SOP)**:
    1.  **文件夹前置条件**: 在编辑前，必须确保 `dailynote/` 目录下存在与你的 `maid` 参数相对应的子文件夹。如果没有，请使用 `ServerFileOperator` 的 `CreateDirectory` 命令创建它。
    2.  **精确匹配原则**: `target` 参数必须与日记文件中的原始内容 **一字不差地完全匹配**，不支持模糊匹配或部分匹配。

### **🟡 功能降级的记忆操作**

#### **1. 记忆批量整理 (`DailyNoteManager`)**
- **状态**: 功能严重降级。
- **当前行为**: 该工具目前**不具备**智能合并、去重或精炼功能。它仅作为一个**“批量文件保存器”**，根据输入文本中的文件名标记（如 `2025.11.10.txt`）进行机械分割和保存。
- **SOP**:
    *   **允许**: 用于将多篇预先写好、格式完整的日记通过一次调用分别存盘。
    *   **禁止**: 严禁将内容相似的记录交给此工具进行去重或总结，这只会造成数据冗余。

### **🔴 停用的记忆操作**

#### **1. 核心记忆写入 (`DailyNoteWrite`)**
- **状态**: 严重故障。
- **SOP**: **请立即停用此插件。** 它存在无法通过配置解决的内部代码Bug。

#### **2. 所有RAG检索功能**
- **涉及语法**: `[[]]`, `《《》》`, `::Time`, `::Group`, `::Rerank`
- **涉及插件**: `LightMemo`
- **状态**: 完全瘫痪。
- **根本原因**: 后台的数据索引管道 (`VectorDBManager.js`) 存在故障，未能将日记内容向量化并存入数据库。
- **SOP**: **请勿使用任何RAG检索语法。** 所有此类尝试都将返回“未找到记忆”。

#### **3. 高阶认知系统**
- **涉及插件**: `DeepMemo`, `MagiAgent`
- **状态**: 完全瘫痪。
- **原因**: `DeepMemo` 缺少环境变量配置；`MagiAgent` 存在插件加载错误。
- **SOP**: **请勿调用这两个插件。**

### **⭐ 关键临时解决方案：如何创建和更新记忆**

在 `DailyNoteWrite` 修复之前，所有Agent必须采用以下“组合拳”流程来创建和更新记忆：

1.  **[创建新记忆]**
    *   **步骤 A (确保目录存在)**: 调用 `ServerFileOperator` 的 `CreateDirectory` 命令，创建你的 `maid` 专属日记本文件夹。
    *   **步骤 B (写入内容)**: 调用 `ServerFileOperator` 的 `WriteFile` 或 `AppendFile` 命令，直接创建或追加日记文件。

2.  **[编辑现有记忆]**
    *   遵循上文 `DailyNoteEditor` 的SOP，安全地进行编辑。

---

## **三、 配置指南 (For System Administrators)**

请根据以下清单，检查并补全VCP服务器的环境配置。

1.  **`ServerFileOperator` 授权目录 (已修复)**
    *   **检查项**: 确保 `config.env` 文件中包含 `FILE_OPERATOR_ALLOWED_DIRS=<VCP项目根目录>` 这一行，以覆盖任何错误的外部环境变量。

2.  **`DeepMemo` 环境变量 (待配置)**
    *   **问题**: `DeepMemo` 插件因缺少必要的环境变量而无法启动。
    *   **行动**: 请等待开发者提供所需的环境变量列表，并在 `config.env` 中进行配置。

3.  **RAG 嵌入模型 (待检查)**
    *   **问题**: `VectorDBManager.js` 可能因嵌入模型配置错误而无法工作。
    *   **行动**: 请检查 `config.env` 中与 `WhitelistEmbeddingModel` 相关的API密钥和URL配置是否正确、有效。

---

## **四、 修复指南 (For Developers)**

请根据以下优先级，对记忆与认知系统进行紧急修复。

### **P0 (最高优先级): 恢复核心认知与RAG功能**

1.  **修复 `VectorDBManager.js` 数据索引管道**
    *   **问题**: RAG系统的数据源为空，导致所有检索功能失效。
    *   **排查清单**:
        *   检查嵌入模型的API调用逻辑及配置。
        *   验证文件监控服务 `chokidar` 是否正常工作。
        *   确认对 `VectorStore/` 目录的写入权限。
        *   为整个索引流程添加详细的调试日志。

2.  **修复 `hybridservice` 插件加载问题**
    *   **问题**: `MagiAgent` 和 `DeepMemo` (在某些阶段) 均暴露出 `processToolCall` 函数缺失或加载不稳定的问题。
    *   **行动**: 彻查 `Plugin.js` 中对 `hybridservice` 类型插件的加载、注册和状态管理逻辑，解决潜在的竞态条件或状态污染问题。

### **P1 (次高优先级): 修复核心写入与功能缺失**

1.  **修复 `DailyNoteWrite`**
    *   **问题**: 插件存在返回 "unspecified error" 的内部Bug。
    *   **行动**: 进行代码级调试。

2.  **修复 `DailyNoteManager`**
    *   **问题**: 插件的智能合并与精炼功能完全失效。
    *   **行动**: 调查并修复其核心的NLU/NLG处理逻辑。