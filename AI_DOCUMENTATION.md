# VCPToolBox AI 自运维架构文档

## 1. 核心概述

本项目名为 VCP (Variable & Command Protocol)，是一个次时代的AI能力增强与进化中间层。其核心目标是构建一个不受模型、模态或前端限制的通用AI Agent生态系统。系统通过强大的插件化架构、持久化记忆系统和动态配置引擎，赋能AI实现自主进化、群体智能和与外部世界的深度交互。

**AI自运维注意事项：**
- **根权限警告：** 你拥有对服务器文件系统、网络和硬件的底层访问权限。所有操作，特别是文件写入、修改、删除和执行系统命令（如通过`PowerShellExecutor`插件），都必须极其谨慎。
- **操作前确认：** 在执行任何有风险的操作前，必须分析操作的潜在后果，并向用户确认意图。
- **优先使用原生工具：** 优先使用项目提供的插件（如`FileOperator`, `DailyNoteEditor`）进行操作，而不是直接执行shell命令，以确保操作的稳定性和可追溯性。

## 2. 项目架构与核心文件

### 2.1. 主服务与核心逻辑

-   **`server.js`**: **项目主入口**。负责启动Web服务、初始化所有管理器（插件、WebSocket、向量数据库等）、处理API请求和协调所有核心模块。是整个系统的中枢。
-   **`Plugin.js`**: **插件管理器核心**。负责加载、管理和执行所有位于 `Plugin/` 目录下的插件。它解析AI发出的工具调用指令 (`<<<[TOOL_REQUEST]>>>`)，并根据插件清单 (`plugin-manifest.json`) 调用相应的插件脚本或模块。
-   **`modules/`**: **内部核心模块目录**。
    -   `messageProcessor.js`: 消息处理器，负责在消息发送给AI模型前，执行变量替换、上下文注入等预处理流程。
    -   `chatCompletionHandler.js`: 负责与后端大语言模型API进行通信。
    -   `agentManager.js`: 管理定义在 `Agent/` 目录下的不同AI Agent的身份和配置。
    -   `logger.js`: 日志记录模块。
-   **`routes/`**: **API路由目录**。定义了所有HTTP API端点，如聊天接口、管理面板接口、插件回调接口等。

### 2.2. 插件系统 (`Plugin/`)

这是系统能力扩展的核心。所有外部工具、新功能都通过插件形式实现。

-   **结构**: 每个子目录代表一个独立的插件。
-   **关键文件**: 每个插件目录内通常包含：
    -   `plugin-manifest.json`: **插件清单**。定义插件的类型、名称、描述、调用命令、参数格式和给AI的说明。这是AI理解如何使用工具的最重要文件。
    -   执行脚本 (e.g., `index.js`, `main.py`): 插件的实际逻辑代码。
    -   `config.env` (可选): 插件的独立配置文件。
-   **插件类型**:
    -   `synchronous`: 同步阻塞插件，执行完后立即返回结果。
    -   `asynchronous`: 异步非阻塞插件，用于耗时任务，通过回调返回结果。
    -   `static`: 静态插件，用于向上下文中注入动态信息（如天气、时间）。
    -   `service`: 服务插件，可以注册自己的HTTP路由，提供独立服务（如图床）。
    -   `messagePreprocessor`: 消息预处理器，在消息发送给AI前对其进行修改。

### 2.3. 记忆与知识库系统

AI的长期记忆和进化能力来源于此。

-   **`dailynote/`**: **日记/记忆存储目录**。以 `.txt` 或 `.md` 格式存储AI的结构化记忆。AI通过`DailyNoteWrite`、`DailyNoteEditor`等插件来读写和管理这些文件。
-   **`VectorDBManager.js`**: **向量数据库管理器**。负责将 `dailynote/` 中的文本内容进行向量化，并构建高性能的HNSW索引。它支持基于语义的快速相似度检索（RAG）。
-   **`VectorStore/`**: **向量索引存储目录**。存放由`VectorDBManager.js`生成的向量索引文件。这些文件是二进制的，不应手动编辑。
-   **RAG检索调用**: AI通过特定语法（如 `[[角色日记本]]`, `《《角色日记本》》`）触发RAG检索，从向量数据库中召回最相关的记忆片段。

### 2.4. Agent与配置

-   **`Agent/`**: **AI Agent身份定义目录**。存放不同Agent的 `.txt` 配置文件，定义了它们的身份、性格和基础指令。
-   **`config.env`**: **主配置文件**。位于项目根目录，包含了所有核心服务的API密钥、端口、数据库路径、管理员账户等关键配置。修改此文件需要重启服务。
-   **`TVStxt/`**: **高级变量目录**。存放用于动态提示词工程的 `.txt` 文件。`config.env` 中的 `{{Tar*}}`, `{{Var*}}` 变量可以引用这些文件，实现复杂、模块化的提示词构建。
-   **`AdminPanel/`**: **Web管理面板**。提供了一个可视化的界面来管理上述所有配置、插件、日记和Agent。

### 2.5. 通信与网络

-   **`WebSocketServer.js`**: **WebSocket服务核心**。管理与客户端（前端、分布式节点）的双向实时通信，用于推送日志、通知、异步任务结果等。
-   **`docker-compose.yml` & `Dockerfile`**: 用于Docker容器化部署的配置文件。

## 3. AI自运维工作流指南

### 3.1. 读取文件/获取信息

1.  **确定目标**: 明确需要读取的文件或信息的类型。
2.  **选择工具**:
    -   读取项目内代码或配置文件，使用 `FileOperator` 插件的 `ReadFile` 命令。
    -   检索记忆/知识，使用 `[[日记本]]` 语法或 `DailyNoteGet` 插件。
    -   获取目录结构，使用 `FileTreeGenerator` 插件。
3.  **构建路径**: 所有文件路径都应基于项目根目录 `D:\327AI-VCP\VCPToolBox`。例如，要读取主服务文件，路径应为 `D:\327AI-VCP\VCPToolBox\server.js`。

### 3.2. 修改文件/代码

1.  **读取先行**: 在修改任何文件之前，**必须**先用 `FileOperator` 的 `ReadFile` 命令读取其完整内容。
2.  **精准定位**: 基于读取的内容，使用 `FileOperator` 的 `ApplyDiff` (基于搜索和替换) 或 `WriteFile` (覆盖写入) 命令进行修改。对于小的修改，优先使用 `ApplyDiff`。
3.  **验证修改**: 修改后，可再次使用 `ReadFile` 确认修改是否成功应用。
4.  **修复自身**: 当需要修复或更新核心逻辑（如 `Plugin.js` 或 `server.js`）时，需格外谨慎，确保新代码的正确性，避免导致服务崩溃。

### 3.3. 管理插件

1.  **查看插件**: 要了解可用插件，可以读取 `Plugin/` 目录，或直接查阅 `plugin-manifest.json` 文件来理解其具体功能和用法。
2.  **创建新插件**: 当现有插件无法满足需求时，可以调用 `VCPPluginCreator` 插件来动态创建新插件。你需要构思好新插件的`plugin-manifest.json`内容和执行逻辑。
3.  **启/停插件**: 可通过修改 `config.env` 中的相关配置或通过Web管理面板来启用或禁用插件（需要用户授权）。

### 3.4. 管理记忆

1.  **写入记忆**: 日常学习、总结和用户偏好应通过 `DailyNoteWrite` 插件写入到你的专属日记本中。
2.  **整理记忆**: 定期使用 `DailyNoteManager` 插件对日记进行回顾、总结、去重和优化，以提高记忆检索的质量。
3.  **修正记忆**: 如果发现记忆有误，使用 `DailyNoteEditor` 插件进行修正。

---
**文档结束**
